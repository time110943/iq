<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>منصة السادس</title>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <!-- Seek Buttons plugin CSS -->
  <link href="https://unpkg.com/videojs-seek-buttons/dist/videojs-seek-buttons.css" rel="stylesheet" />
  <!-- polyfills للأجهزة القديمة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
  <!-- Babel لتحويل الكود ES6+ إلى ES5 على المتصفح -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --primary: #c62828;
      --bg-color: #0a0a0a;
      --text-color: #f5f5f5;
      --card-color: #1a1a1a;
      --border-color: #333;
    }
    [data-theme="light"] {
      --bg-color: #ffffff;
      --text-color: #000000;
      --card-color: #f5f5f5;
      --border-color: #ddd;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Almarai', sans-serif; user-select: none; }
    body { background: var(--bg-color); color: var(--text-color); line-height: 1.6; }
    .page { display: none; padding: 2rem; max-width: 1200px; margin: 0 auto; }
    .page.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    header { background: var(--card-color); padding: 1rem 2rem; display: flex; align-items: center; gap: 2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 3px 6px rgba(0,0,0,0.16); }
    .site-title { color: var(--primary); font-size: 1.8rem; cursor: pointer; transition: transform 0.3s; }
    .site-title:hover { transform: scale(1.05); }
    .search-container { flex-grow: 1; max-width: 600px; display: flex; gap: 0.5rem; }
    #searchInput { width: 100%; padding: 0.8rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-color); color: var(--text-color); font-size: 1rem; }
    #searchButton, #themeToggle { background: var(--primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    #searchButton { padding: 0 1.5rem; }
    #themeToggle { padding: 0.5rem 1rem; }
    #searchButton:hover, #themeToggle:hover { opacity: 0.9; }
    .teachers-grid { display: flex; overflow-x: auto; gap: 2rem; padding: 1rem 0; margin-top: 2rem; }
    .teacher-card { background: var(--card-color); padding: 1.5rem; border-radius: 15px; min-width: 280px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
    .teacher-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    .teacher-img { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); display: block; margin: 0 auto; }
    .teacher-name { margin: 1rem 0; text-align: center; font-size: 1.2rem; }
    .classes-page { display: grid; gap: 2rem; }
    .teacher-info { background: var(--card-color); padding: 1.5rem; border-radius: 10px; display: flex; align-items: center; gap: 1rem; }
    .teacher-img-lg { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
    .back-button, .copy-button { background: var(--primary); color: #fff; border: none; padding: 0.8rem 1.5rem; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-bottom: 1rem; }
    .copy-button { margin-top: 1rem; font-size: 1rem; }
    .back-button:hover, .copy-button:hover { opacity: 0.9; }
    .classes-list { display: grid; gap: 1.5rem; }
    .class-card { background: var(--card-color); padding: 1rem; border-radius: 10px; cursor: pointer; }
    .class-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-left: 4px solid var(--primary); }
    .lectures-list { display: none; gap: 0.8rem; margin-top: 1rem; padding-right: 1rem; }
    .lecture-item { position: relative; padding: 1rem 1rem 1rem 2.5rem; background: var(--bg-color); border-radius: 8px; border-right: 3px solid var(--primary); cursor: pointer; transition: 0.3s; }
    .lecture-item:hover { background: #4a1a1a; transform: translateX(10px); }
    .checkmark { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1rem; color: var(--primary); }
    .video-page { display: flex; flex-direction: column; gap: 2rem; }
    /* الحاوية المرنة للمشغل بنسبة 16:9 */
    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 aspect ratio */
      background: black;
      overflow: hidden;
    }
    /* جعل المشغل يحتل كامل الحاوية ويضم شريط التحكم */
    .video-container .video-js {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .video-details { background: var(--card-color); padding: 1.5rem; border-radius: 10px; text-align: center; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 200; }
    .modal-content { background: var(--card-color); padding: 1.5rem; border-radius: 10px; text-align: center; position: relative; max-width: 300px; width: 90%; }
    .modal-content img { width: 150px; height: 150px; border-radius: 50%; margin-bottom: 1rem; }
    .modal-content a { display: inline-block; background: var(--primary); color: #fff; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; margin-top: 1rem; transition: 0.3s; }
    .modal-content a:hover { opacity: 0.9; }
    .close-modal { position: absolute; top: 0.5rem; left: 0.5rem; background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }
    @media (max-width: 768px) {
      header { flex-direction: column; padding: 1rem; gap: 1rem; }
      .search-container { width: 100%; }
      .teachers-grid { flex-direction: column; }
      .teacher-card { min-width: auto; }
      .teacher-info { flex-direction: column; text-align: center; }
      .teacher-img { width: 150px; height: 150px; }
    }
  </style>
</head>
<body>
  <div id="jsonViewer" style="display: none; background: var(--card-color); padding: 1rem; margin: 2rem; border-radius: 8px;">
    <pre id="jsonContent" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
  </div>

  <header>
    <h1 class="site-title" onclick="navigate('home')">منصة السادس</h1>
    <button id="themeToggle">تبديل الوضع</button>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="ابحث عن مدرس...">
      <button id="searchButton">بحث</button>
    </div>
  </header>

  <div id="homePage" class="page active">
    <div class="teachers-grid" id="teachersGrid"></div>
  </div>

  <div id="classesPage" class="page">
    <div class="classes-page">
      <button class="back-button" onclick="navigate('home')">← الرجوع للمدرسين</button>
      <div class="teacher-info">
        <img id="teacherImage" class="teacher-img-lg" alt="صورة المدرس">
        <div>
          <h2 id="teacherName"></h2>
          <p id="teacherSubject"></p>
        </div>
      </div>
      <div class="classes-list" id="classesList"></div>
    </div>
  </div>

  <div id="videoPage" class="page">
    <div class="video-page">
      <div class="video-container">
        <video
          id="player"
          class="video-js vjs-default-skin"
          playsinline
          controls
        ></video>
      </div>
      <div class="video-details">
        <h2 id="videoTitle"></h2>
        <p id="videoDescription"></p>

        <button class="back-button" onclick="navigate('classes')">العودة للفصول</button>
      </div>
    </div>
  </div>

  <div id="telegramModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">×</button>
      <img src="https://i.imghippo.com/files/UYRH9532HY.png" alt="قناة التليجرام">
      <h3>يرجى الاشتراك في قناة التليجرام </h3>
      <p></p>
      <a href="https://t.me/sads86ff" target="_blank">اذهب للقناة</a>
    </div>
  </div>

  <!-- Video.js وملحقات -->
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <script src="https://unpkg.com/videojs-seek-buttons/dist/videojs-seek-buttons.min.js"></script>

  <script type="text/babel">
    // إعداد الثيم
    function initializeTheme() {
      var stored = localStorage.getItem('theme');
      var theme = stored || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      document.documentElement.setAttribute('data-theme', theme);
    }
    initializeTheme();
    document.getElementById('themeToggle').addEventListener('click', function() {
      var cur = document.documentElement.getAttribute('data-theme');
      var next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // إدارة حفظ التقدم
    var completedLectures = JSON.parse(localStorage.getItem('completedLectures') || '{}');
    function saveCompleted() {
      localStorage.setItem('completedLectures', JSON.stringify(completedLectures));
    }
    function markLectureCompleted(url) {
      if (!completedLectures[url]) {
        completedLectures[url] = true;
        saveCompleted();
        if (currentTeacher) renderClasses(currentTeacher.classes);
      }
    }

    // تهيئة Video.js
    var videoPlayer = videojs('player', {
      controls: true,
      playbackRates: [0.5, 1, 1.25, 1.5, 2],
      html5: { hls: { overrideNative: true } },
      controlBar: {
        pictureInPictureToggle: false,
        fullscreenToggle: true,
        volumePanel: false   // إزالة زر الصوت
      }
    });
    // إضافة أزرار التقديم والتأخير
    videoPlayer.seekButtons({ forward: 10, back: 10 });

    var pages = {
      home: document.getElementById('homePage'),
      classes: document.getElementById('classesPage'),
      video: document.getElementById('videoPage')
    };
    var teachersGrid = document.getElementById('teachersGrid');
    var searchInput = document.getElementById('searchInput');
    var searchButton = document.getElementById('searchButton');
    var teachers = [], currentTeacher = null, currentClassIndex = 0, currentLectureIndex = 0, currentLectureLink = '';

    function navigate(page) {
      window.scrollTo(0,0);
      if (page !== 'video') {
        videoPlayer.pause();
        videoPlayer.currentTime(0);
      }
      Object.values(pages).forEach(el => el.classList.remove('active'));
      pages[page].classList.add('active');
    }

   function copyLectureLink() {
      if (!currentLectureLink) return;
      navigator.clipboard.writeText(currentLectureLink)
        .then(() => alert('تم نسخ رابط المحاضرة'))
        .catch(() => alert('حدث خطأ أثناء النسخ'));
    }
    
    function renderTeachers(list) {
      list = list || teachers;
      if (!list.length) {
        teachersGrid.innerHTML = '<p>لا يوجد نتائج مطابقة</p>';
        return;
      }
      teachersGrid.innerHTML = list.map(t =>
        `<div class="teacher-card" onclick="showTeacher('${t.id}')">
          <img src="${t.image}" alt="${t.name}" class="teacher-img">
          <h3 class="teacher-name">${t.name}</h3>
          <p>${t.subject}</p>
        </div>`
      ).join('');
    }
    function showTeacher(id) {
      currentTeacher = teachers.find(t => t.id == id);
      if (!currentTeacher) return;
      document.getElementById('teacherImage').src = currentTeacher.image;
      document.getElementById('teacherName').textContent = currentTeacher.name;
      document.getElementById('teacherSubject').textContent = currentTeacher.subject;
      renderClasses(currentTeacher.classes);
      navigate('classes');
    }
    function renderClasses(classesData) {
      document.getElementById('classesList').innerHTML = classesData.map((cls, ci) => {
        var lectures = cls.lectures.map((lec, li) => {
          var done = completedLectures[lec.url];
          return `<div class="lecture-item" onclick="playVideo(${ci},${li},'${lec.url}','${lec.title}','${lec.description}')">
            ${li+1}. ${lec.title}${done?'<span class="checkmark">✔</span>':''}
          </div>`;
        }).join('');
        return `<div class="class-card">
          <div class="class-header" onclick="toggleLectures(this)">
            <h3>${cls.name}</h3><span>▼</span>
          </div>
          <div class="lectures-list">${lectures}</div>
        </div>`;
      }).join('');
    }
    function toggleLectures(el) {
      var list = el.parentElement.querySelector('.lectures-list');
      var arrow = el.querySelector('span');
      if (!list.style.display || list.style.display === 'none') {
        list.style.display = 'grid';
        arrow.textContent = '▲';
      } else {
        list.style.display = 'none';
        arrow.textContent = '▼';
      }
    }
    function playVideo(ci, li, url, title, desc) {
      currentClassIndex = ci;
      currentLectureIndex = li;
      currentLectureLink = url;
      var type = url.endsWith('.m3u8')
        ? 'application/vnd.apple.mpegurl'
        : 'video/mp4';
      videoPlayer.src({ src: url, type: type });
      videoPlayer.play();
      document.getElementById('videoTitle').textContent = title;
      document.getElementById('videoDescription').textContent = desc;
      navigate('video');
    }
    videoPlayer.on('ended', function() {
      markLectureCompleted(currentLectureLink);
      var cls = currentTeacher.classes, ci = currentClassIndex, li = currentLectureIndex;
      if (li < cls[ci].lectures.length - 1) {
        li++;
      } else if (ci < cls.length - 1) {
        ci++; li = 0;
      } else return;
      var next = cls[ci].lectures[li];
      playVideo(ci, li, next.url, next.title, next.description);
    });

    function handleSearch() {
      var term = searchInput.value.trim().toLowerCase();
      renderTeachers(
        teachers.filter(t =>
          t.name.toLowerCase().includes(term) ||
          t.subject.toLowerCase().includes(term)
        )
      );
    }
    var searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 300);
    });
    searchButton.addEventListener('click', handleSearch);

    function loadData(){
      var errorMsg = '<p class="error">حدث خطأ في تحميل البيانات</p>';
      fetch('/api/data', { headers: { 'Referer': 'https://careful-burnt-honesty.glitch.me/' } })
        .then(res => { if (!res.ok) throw new Error('فشل تحميل البيانات'); return res.json(); })
        .then(data => {
          teachers = data.teachers;
          renderTeachers();
          console.log('بيانات JSON:', data);
        })
        .catch(error => {
          console.error('Error:', error);
          teachersGrid.innerHTML = errorMsg +
            '<button onclick="location.reload()" style="margin-top:1rem;padding:0.5rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:5px;">إعادة تحميل البيانات</button>';
        });
    }
    function closeModal() {
      document.getElementById('telegramModal').style.display = 'none';
    }
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());

    loadData();
  </script>
</body>
</html>
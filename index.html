<script type="text/babel">
  // دالة البروكسي للفيديوهات فقط
  function proxify(url) {
    if (!url || typeof url !== 'string') return url;
    if (url.startsWith('https://alii.ptutfzukxt.workers.dev/proxy_iframe?url=')) return url;
    if (url.startsWith('http://') || url.startsWith('https://')) {
      return 'https://alii.ptutfzukxt.workers.dev/proxy_iframe?url=' + encodeURIComponent(url);
    }
    return url;
  }

  function initializeTheme() {
    var stored = localStorage.getItem('theme');
    var theme = stored || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    document.documentElement.setAttribute('data-theme', theme);
  }
  initializeTheme();
  document.getElementById('themeToggle').addEventListener('click', function() {
    var cur = document.documentElement.getAttribute('data-theme');
    var next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });

  var hls;
  var player = new Plyr('#player', {
    controls: ['play-large','rewind','play','fast-forward','progress','current-time','mute','volume','captions','settings','airplay','fullscreen'],
    settings: ['speed','quality'], speed:{selected:1,options:[0.5,1,1.25,1.5,2]}, seekTime:10
  });

  var pages={home:document.getElementById('homePage'),classes:document.getElementById('classesPage'),video:document.getElementById('videoPage')};
  var teachersGrid=document.getElementById('teachersGrid');var searchInput=document.getElementById('searchInput');var searchButton=document.getElementById('searchButton');
  var teachers=[],currentTeacher=null,currentClassIndex=0,currentLectureIndex=0,currentLectureLink='';

  function navigate(page){window.scrollTo(0,0);if(page!=='video'){player.pause();if(hls){hls.destroy();hls=null;}}Object.keys(pages).forEach(function(k){pages[k].classList.remove('active');});pages[page].classList.add('active');}
  function copyLectureLink(){if(!currentLectureLink)return;navigator.clipboard.writeText(currentLectureLink).then(function(){alert('تم نسخ رابط المحاضرة');}).catch(function(){alert('حدث خطأ أثناء النسخ');});}

  function renderTeachers(list){list=list||teachers;if(!list.length){teachersGrid.innerHTML='<p>لا يوجد نتائج مطابقة</p>';return;}teachersGrid.innerHTML=list.map(function(t){return '<div class="teacher-card" onclick="showTeacher(\''+t.id+'\')"><img src="'+t.image+'" alt="'+t.name+'" class="teacher-img"><h3 class="teacher-name">'+t.name+'</h3><p>'+t.subject+'</p></div>';}).join('');}
  function showTeacher(id){currentTeacher=teachers.find(function(t){return t.id==id;});if(!currentTeacher)return;document.getElementById('teacherImage').src=currentTeacher.image;document.getElementById('teacherName').textContent=currentTeacher.name;document.getElementById('teacherSubject').textContent=currentTeacher.subject;renderClasses(currentTeacher.classes);navigate('classes');}
  function renderClasses(classesData){document.getElementById('classesList').innerHTML=classesData.map(function(cls,ci){var lectures=cls.lectures.map(function(lec,li){var done=completedLectures[lec.url];return '<div class="lecture-item" onclick="playVideo('+ci+','+li+',\''+lec.url.replace(/'/g,"\\'")+'\',\''+lec.title.replace(/'/g,"\\'")+'\',\''+lec.description.replace(/'/g,"\\'")+'\')">'+(li+1)+'. '+lec.title+(done?'<span class="checkmark">✔</span>':'')+'</div>';}).join('');return '<div class="class-card"><div class="class-header" onclick="toggleLectures(this)"><h3>'+cls.name+'</h3><span>▼</span></div><div class="lectures-list">'+lectures+'</div></div>';}).join('');}
  function toggleLectures(el){var list=el.parentElement.querySelector('.lectures-list');var arrow=el.querySelector('span');if(!list.style.display||list.style.display==='none'){list.style.display='grid';arrow.textContent='▲';}else{list.style.display='none';arrow.textContent='▼';}}

  // هنا تم تعديل تشغيل الفيديو ليستخدم البروكسي
  function playVideo(ci,li,url,title,desc){
    currentClassIndex=ci; currentLectureIndex=li; currentLectureLink=url;
    var video=document.getElementById('player');
    var proxied = proxify(url); // تمرير الفيديو عبر البروكسي

    if(url.endsWith('.m3u8')){
      if(hls){ hls.destroy(); hls=null; }
      if(Hls.isSupported()){
        hls=new Hls();
        hls.loadSource(proxied);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function(){player.play();});
      } else if(video.canPlayType('application/vnd.apple.mpegurl')){
        video.src=proxied;
        video.addEventListener('loadedmetadata',function(){player.play();});
      } else {
        alert('هذا المتصفح لا يدعم بث الفيديو بهذا الصيغة');
        return;
      }
    } else {
      player.source={type:'video',sources:[{src:proxied,type:'video/mp4'}]};
      player.play();
    }

    document.getElementById('videoTitle').textContent=title;
    document.getElementById('videoDescription').textContent=desc;
    navigate('video');
  }
</script>
